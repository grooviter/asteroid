<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.4">
<title>Asteroid</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Asteroid</h1>
<div class="details">
<span id="revnumber">version 0.2.1</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_what_is_asteroid">1. What is Asteroid</a></li>
<li><a href="#_show_me_the_code">2. Show me the code</a>
<ul class="sectlevel2">
<li><a href="#_gradle">2.1. Gradle</a></li>
<li><a href="#_example">2.2. Example</a></li>
</ul>
</li>
<li><a href="#_overview">3. Overview</a>
<ul class="sectlevel2">
<li><a href="#_transform_abstractions">3.1. Transform abstractions</a></li>
<li><a href="#_ast_nodes_functions">3.2. AST nodes functions</a>
<ul class="sectlevel3">
<li><a href="#_the_a_class">3.2.1. The A class</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_theory">4. Theory</a>
<ul class="sectlevel2">
<li><a href="#_ast">4.1. AST</a>
<ul class="sectlevel3">
<li><a href="#_expressions">4.1.1. Expressions</a></li>
<li><a href="#_statements">4.1.2. Statements</a></li>
<li><a href="#_high_level_nodes">4.1.3. High level Nodes</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_local_transformations">5. Local Transformations</a>
<ul class="sectlevel2">
<li><a href="#_overview_2">5.1. Overview</a></li>
<li><a href="#__local">5.2. @Local</a></li>
<li><a href="#__code_applyto_code">5.3. <code>applyTo</code></a></li>
<li><a href="#_abstractlocaltransformation">5.4. AbstractLocalTransformation</a></li>
<li><a href="#__phase">5.5. @Phase</a></li>
<li><a href="#_compilation_errors">5.6. Compilation errors</a></li>
<li><a href="#_checks">5.7. Checks</a>
<ul class="sectlevel3">
<li><a href="#_your_own_transformations">5.7.1. Your own transformations</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_global_transformations">6. Global Transformations</a>
<ul class="sectlevel2">
<li><a href="#_overview_3">6.1. Overview</a></li>
<li><a href="#_example_2">6.2. Example</a></li>
<li><a href="#_transformers">6.3. Transformers</a>
<ul class="sectlevel3">
<li><a href="#_classnodetransformer">6.3.1. ClassNodeTransformer</a></li>
<li><a href="#_expression_transformers">6.3.2. Expression transformers</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_fluent_api">7. Fluent API</a>
<ul class="sectlevel2">
<li><a href="#_nodes">7.1. Nodes</a></li>
<li><a href="#_expressions_2">7.2. Expressions</a></li>
<li><a href="#_statements_2">7.3. Statements</a></li>
<li><a href="#_modifiers">7.4. Modifiers</a></li>
<li><a href="#_utils">7.5. Utils</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Asteroid is a set of utilities to make it easier to develop
<a href="http://www.groovy-lang.org">Groovy</a> AST transformations.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_is_asteroid">1. What is Asteroid</h2>
<div class="sectionbody">
<div class="paragraph">
<p>AST transformations, have been historically a hard topic in
Groovy. Asteroid is a set of utilities and ideas trying to reduce the
complexity of dealing with transformations.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Apache</div>
<div class="paragraph">
<p>The <strong>Asteroid</strong> project is open sourced under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache 2 License</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>If you have never done any AST transformation I&#8217;d recommend you to
take a look both the
<a href="http://groovy-lang.org/metaprogramming.html#developing-ast-xforms">Groovy</a>
documentation and the theory chapter. If you already now the stuff
then read on.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
At the moment <strong>Asteroid</strong> development is in an alpha
state. Please check the changelog file to follow the progress of the
project.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_show_me_the_code">2. Show me the code</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_gradle">2.1. Gradle</h3>
<div class="paragraph">
<p>In order to use <code>Asteroid</code> in your Groovy code you can find it in Bintray:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">repositories {
    maven {
        url  "http://dl.bintray.com/grooviter/maven"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can add the dependency to your project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">compile 'com.github.grooviter:asteroid:0.2.0'</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_example">2.2. Example</h3>
<div class="paragraph">
<p>To show the benefit of using Asteroid, I will be following the
tutorial about local transformation available at the
<a href="http://www.groovy-lang.org/metaprogramming.html#transforms-local">Groovy
official site</a>. The code of the following example is available at the
<code>asteroid-test</code> module at
<a href="https://github.com/grooviter/asteroid/tree/master/asteroid-test">Github</a>.</p>
</div>
<div class="paragraph">
<p>Given a code like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@WithLogging
def greet() {
    println "Hello World"
}

greet()</code></pre>
</div>
</div>
<div class="paragraph">
<p>We would like to print a start and stop message along with the message printed by the method itself. So in this
example we&#8217;ll be expecting an output like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-text" data-lang="text">start greet
Hello World
stop greet</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a local transformation only two things are required:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The annotation used as a marker. In this example the <code>@WithLogging</code> annotation</p>
</li>
<li>
<p>The transformation implementation</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Lets see first the <code>@WithLogging</code> annotation declaration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package asteroid.local.samples

import asteroid.Local

@Local(
    value   = WithLoggingTransformationImpl, <i class="conum" data-value="1"></i><b>(1)</b>
    applyTo = Local.TO.METHOD)               <i class="conum" data-value="2"></i><b>(2)</b>
@interface WithLogging { }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The transformation implementation class</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This annotation will be applied to method elements.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default <code>@Local</code> annotation assumes the annotation is applied to a <code>type</code> (classes). So if you are using the annotation for a type then you could omit <code>value</code> and <code>applyTo</code> attributes an write just the class of the transformation like this: <code>@Local(ImplementationClass)</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now it&#8217;s time to implement the transformation. The transformation
should be an instance of
<code>asteroid.local.AbstractLocalTransformation</code>. We have to extend
<code>AbstractLocalTransformation</code> and provide two generic arguments:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The annotation class used to mark our transformation: <code>WithLogging</code></p>
</li>
<li>
<p>The type of nodes that will be affected by this transformation. In this example <code>org.codehaus.groovy.ast.MethodNode</code></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package asteroid.local.samples

import asteroid.A
import asteroid.Phase
import asteroid.AbstractLocalTransformation

import groovy.transform.CompileStatic

import org.codehaus.groovy.ast.AnnotationNode
import org.codehaus.groovy.ast.MethodNode
import org.codehaus.groovy.ast.stmt.Statement
import org.codehaus.groovy.ast.expr.Expression

@CompileStatic
@Phase(Phase.LOCAL.SEMANTIC_ANALYSIS) <i class="conum" data-value="1"></i><b>(1)</b>
class WithLoggingTransformationImpl extends AbstractLocalTransformation&lt;WithLogging, MethodNode&gt; {

    @Override
    void doVisit(final AnnotationNode annotation, final MethodNode methodNode) {
        def oldCode   = methodNode.code   <i class="conum" data-value="2"></i><b>(2)</b>
        def startCode = printlnS("start") <i class="conum" data-value="3"></i><b>(3)</b>
        def endCode   = printlnS("end")   <i class="conum" data-value="4"></i><b>(4)</b>

        methodNode.code = A.STMT.blockS(startCode, oldCode, endCode) <i class="conum" data-value="5"></i><b>(5)</b>
    }

    Statement printlnS(String message) {
        return A.STMT.stmt(A.EXPR.callThisX("println", A.EXPR.constX(message))) <i class="conum" data-value="6"></i><b>(6)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@Phase</code> annotation indicates in which compilation phase this transformation will be applied.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Storing temporary the old code we want to transform which is an <code>org.codehaus.groovy.ast.stmt.Statement</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Building <code>println "start"</code> code, which is wrapped in a <code>org.codehaus.groovy.ast.stmt.Statement</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Building <code>println "end"</code> code, which is wrapped in a <code>org.codehaus.groovy.ast.stmt.Statement</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Building the new method code re-arranging the new and old code in order. We are adding all previous in a
<code>BlockStatement</code> in the order we want them to execute.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Building a generic <code>println constantValue</code> expression</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>@CompileStatic</code> annotation is not required it&#8217;s only used here to highlight that all the code used in this
transformation is safely typed and can be optimized by this annotation.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_overview">3. Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At the moment Asteroid is composed by two main groups, abstractions to
reduce the complexity of creating a new transformation, and utility
classes helping to create new Abstract Syntaxt Tree nodes.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images//diag-4608b07edeacc2d2670155ae10dc179a.png" alt="diag 4608b07edeacc2d2670155ae10dc179a" width="1000" height="224">
</div>
</div>
<div class="sect2">
<h3 id="_transform_abstractions">3.1. Transform abstractions</h3>
<div class="paragraph">
<p>So far abstractions used to deal with the AST were too low level. For
instance, you needed to check whether the nodes passed to your
transformation were the ones you wanted to act over or not, and then
proceed.</p>
</div>
<div class="paragraph">
<p>Asteroid tries to provide higher abstractions in order to reduce some
of the boiler plate code, and make the developer to focus on the
transformation only.</p>
</div>
</div>
<div class="sect2">
<h3 id="_ast_nodes_functions">3.2. AST nodes functions</h3>
<div class="paragraph">
<p>The other main part of Asteroid are functions dealing directly with
AST nodes. Functions responsible for modifying AST nodes.</p>
</div>
<div class="paragraph">
<p>They&#8217;re divided in four groups:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Expressions</strong>: Functions responsible for creating expressions</p>
</li>
<li>
<p><strong>Statements</strong>: Functions responsible for creating statements</p>
</li>
<li>
<p><strong>Nodes</strong>: Builders responsible for creating high level nodes</p>
</li>
<li>
<p><strong>Utils</strong>: Functions responsible for querying and querying any type of nodes</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
With the upcoming <code>groovy-macro</code> module in Groovy 2.5.0 most
of the code in Asteroid, used for creating <code>expressions</code> and
<code>statements</code> may be gone for good in favor of the <code>macro</code> method.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="_the_a_class">3.2.1. The A class</h4>
<div class="paragraph">
<p>All functions available in Asteroid are accessible through the
<code>asteroid.A</code> class.</p>
</div>
<div class="paragraph">
<p>Check javadoc: <a href="javadocs/asteroid/A.html"><code>asteroid.A</code></a></p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_theory">4. Theory</h2>
<div class="sectionbody">
<div class="paragraph">
<p>What can you do with an AST transformation ?</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Transform</strong> the Abstract Syntax Tree by adding, or removing
elements from it</p>
</li>
<li>
<p><strong>Check</strong> the structure, or semantics of the Abstract Syntax Tree and do
something about it</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Examples of <strong>adding / removing</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><a href="http://groovy-lang.org/metaprogramming.html#_code_generation_transformations">Groovy</a></strong>: Code generation transformations: @ToString, @Immutable&#8230;&#8203;</p>
</li>
<li>
<p><strong><a href="https://github.com/spockframework/spock">Spock</a></strong>: transforms label statements</p>
</li>
<li>
<p><strong><a href="https://github.com/Arasthel/SwissKnife">Swissknife</a></strong>: reduces boilerplate code in Android dev</p>
</li>
<li>
<p><strong><a href="https://grails.org/">Grails</a></strong>: also saves you from typical web boilerplate code</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="images//grails.png" alt="grails" width="100"></span> <span class="image"><img src="images//spock.png" alt="spock" width="100"></span> <span class="image"><img src="images//swissknife.png" alt="swissknife" width="100" height="100"></span> <span class="image"><img src="images//griffon.png" alt="griffon" width="100"></span></p>
</div>
<div class="paragraph">
<p>Examples of <strong>checking</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><a href="https://github.com/andresteingress/gcontracts">GContracts</a></strong>: programming by contract</p>
</li>
<li>
<p><strong><a href="https://github.com/CodeNarc/CodeNarc">Codenarc</a></strong>: Static Analysis</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="images//codenarc.png" alt="codenarc" height="100"></span></p>
</div>
<div class="paragraph">
<p>Transformations can be of two types:</p>
</div>
<div class="paragraph">
<p><strong>Local</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Relative to the context they are applied to.</p>
</li>
<li>
<p>That context is marked (annotation)</p>
</li>
<li>
<p>Compilation phases are limited</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Global</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Global AST transformations are applied to all source code</p>
</li>
<li>
<p>Compilation phases are less limited</p>
</li>
<li>
<p>Need an extra descriptor file</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_ast">4.1. AST</h3>
<div class="paragraph">
<p>Abstract Syntax Tree (or AST from now on) is the tree-like
representation of the code the compiler needs in order to
generate the bytecode that will be used later by the JVM.</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images//diag-babc24851067e5feb8fc8776b5bb8948.png" alt="diag babc24851067e5feb8fc8776b5bb8948" width="490" height="98">
</div>
</div>
<div class="paragraph">
<p>When dealing with the AST, most of the time we will talking about
three types of elements:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>EXPRESSIONS</strong></p>
</li>
<li>
<p><strong>STATEMENTS</strong></p>
</li>
<li>
<p><strong>HIGH LEVEL</strong> NODES</p>
</li>
</ul>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images//diag-6c894a44eec094de5339c817017775e7.png" alt="diag 6c894a44eec094de5339c817017775e7" width="580" height="336">
</div>
</div>
<div class="sect3">
<h4 id="_expressions">4.1.1. Expressions</h4>
<div class="paragraph">
<p>An <strong>expression</strong> is a <strong>combination</strong> of one or more explicit
<strong>values, constants, variables, operators, and functions</strong> that the
programming language interprets and computes <strong>to produce another
value</strong>.</p>
</div>
<div class="listingblock">
<div class="title">BinaryExpression</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">1 == 1</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images//diag-836fe3d4bdb17e1b2addb10be8c7ea6d.png" alt="diag 836fe3d4bdb17e1b2addb10be8c7ea6d" width="250" height="196">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>constant</strong> expression <em>1</em></p>
</li>
<li>
<p><strong>token</strong> <em>==</em></p>
</li>
<li>
<p><strong>constant</strong> expression <em>1</em></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Method call expression</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">ref.myMethod(3)</code></pre>
</div>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images//diag-c4448142060fbd4b605eb6d5ae5614ca.png" alt="diag c4448142060fbd4b605eb6d5ae5614ca" width="650" height="182">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>variable</strong> expression <em>ref</em></p>
</li>
<li>
<p><strong>constant</strong> <em>myMethod</em></p>
</li>
<li>
<p><strong>param</strong> expression <em>3</em></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_statements">4.1.2. Statements</h4>
<div class="paragraph">
<p>In computer programming, a statement is the <strong>smallest standalone
element</strong> of an imperative programming language that <strong>expresses some
action to be carried out</strong>. A statement may have <strong>expressions</strong>.</p>
</div>
<div class="listingblock">
<div class="title">If Statement</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">if(booleanExpression) {
 println "hello" // statement
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>expression</strong> to evaluate</p>
</li>
<li>
<p><strong>statement</strong> to be executed if the boolean expression evaluates to true</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Block Statement</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">public void main(String[] args) { // block starts
  // this is inside a block statement
} // block ends</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>A block statement is easily recognized by <strong>curly braces</strong></p>
</li>
<li>
<p>It is built from other <strong>statements</strong> containing <strong>expressions</strong></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Block Statement (Cont.)</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">public String greetings() {
    return "Hello Greach"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This block statement contains a <strong>return</strong> statement receiving a constant
expression <strong>Hello Greach</strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_high_level_nodes">4.1.3. High level Nodes</h4>
<div class="paragraph">
<p>Is <strong>how our program is structured</strong>. They group statements and
  expressions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>classes</strong></p>
</li>
<li>
<p><strong>methods</strong></p>
</li>
<li>
<p><strong>fields</strong></p>
</li>
<li>
<p><strong>properties</strong></p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">Class Node</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class A { // ClassNode
   String greetings // FieldNode

   String hello() { // MethodNode

   }
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>ClassNode</strong> may contain: methods, fields&#8230;&#8203;</p>
</li>
<li>
<p><strong>MethodNode</strong> may contain statements, and expressions</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Therefore&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class A { // ClassNode

   String hello() // MethodNode
   { // blockStatement {

       return "Hello" // returnStatement(constantExpression)

    } // }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_local_transformations">5. Local Transformations</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
Local AST transformations are relative to the context they are applied to. In most cases, the context is defined by an
annotation that will define the scope of the transform. For example, annotating a field would mean that the
transformation applies to the field, while annotating the class would mean that the transformation applies to the whole
class.
</blockquote>
<div class="attribution">
&#8212; Groovy official site
</div>
</div>
<div class="sect2">
<h3 id="_overview_2">5.1. Overview</h3>
<div class="paragraph">
<p>In order to create a local transformation you need to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create an <code>annotation</code> annotated by <code>@Local</code></p>
</li>
<li>
<p>Create an <code>implementation</code> of the transformation extending <code>AbstractLocalTransformation</code></p>
</li>
<li>
<p>Your implementation should be annotated by <code>@Phase</code> with the proper
local compilation phase value set.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="__local">5.2. @Local</h3>
<div class="paragraph">
<p>In a local transformation you normally use an annotation to mark those
parts of the code you want to transform: classes, methods&#8230;&#8203; That
annotation should be annotated as well to tell the compiler that is
going to be used as a transformation marker.</p>
</div>
<div class="paragraph">
<p>You can use <code>@Local</code> to annotate a marker annotation. The only
<strong>mandatory</strong> argument is the AST implementation class. Implementation
classes should always extend
<code>asteroid.local.AbstractLocalTransformation</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package asteroid.local.samples

import asteroid.Local

@Local(AsListImpl)
@interface AsList { }</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>@Local</code> annotation does not indicate which type of element is
allowed to annotate by the attribute <code>appliedTo</code> then is supposed to
be used over an element of type <code>TYPE</code>, meaning it will be applied
over an entire class.</p>
</div>
<div class="paragraph">
<p>Underneath the <code>@Local</code> annotation is doing:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images//diag-d1c077a2bcd0cae38f25ad0fa057473d.png" alt="Local annotation transformation" width="1060" height="168">
</div>
<div class="title">Figure 1. Local annotation transformation</div>
</div>
</div>
<div class="sect2">
<h3 id="__code_applyto_code">5.3. <code>applyTo</code></h3>
<div class="paragraph">
<p><code>applyTo</code> attribute is used when the transformation is applied to any
element type other than <code>TYPE</code>: a method, annotation, field&#8230;&#8203;etc.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package asteroid.local.samples

import asteroid.Local

@Local(
    value   = WithLoggingTransformationImpl, <i class="conum" data-value="1"></i><b>(1)</b>
    applyTo = Local.TO.METHOD)               <i class="conum" data-value="2"></i><b>(2)</b>
@interface WithLogging { }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This annotation will be applied to method elements.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The class of the AST transformation implementation</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_abstractlocaltransformation">5.4. AbstractLocalTransformation</h3>
<div class="paragraph">
<p><code>asteroid.local.AbstractLocalTransformation</code> exists to avoid some of the
defensive code that you would normally write at the beggining of an
AST transformation.</p>
</div>
<div class="paragraph">
<p>When coding an AST transformation you always check that the first node
is an <code>AnnotationNode</code> and the second is the type of <code>ASTNode</code> you
expected to be annotated by the first node. Instead of coding that you
can use <code>AbstractLocalTransformation</code>.</p>
</div>
<div class="paragraph">
<p>Lets say I have an annotation <code>@ToMD5</code>. That annotation can only be
used in elements of type <code>FIELD</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package asteroid.local.samples

import asteroid.Local

@Local(value = ToMD5Impl, applyTo = Local.TO.FIELD)
@interface ToMD5 { }</code></pre>
</div>
</div>
<div class="paragraph">
<p>I would like to create a method for every field annotated by <code>ToMD5</code>
returning the MD5 signature of the content of that field.</p>
</div>
<div class="paragraph">
<p>In order to implement that I&#8217;m using <code>AbstractLocalTransformation</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package asteroid.local.samples

import asteroid.A
import asteroid.Phase
import asteroid.AbstractLocalTransformation

import groovy.transform.CompileStatic

import org.codehaus.groovy.ast.AnnotationNode
import org.codehaus.groovy.ast.FieldNode
import org.codehaus.groovy.ast.MethodNode
import org.codehaus.groovy.ast.stmt.BlockStatement

@CompileStatic
@Phase(Phase.LOCAL.SEMANTIC_ANALYSIS) <i class="conum" data-value="1"></i><b>(1)</b>
class ToMD5Impl extends AbstractLocalTransformation&lt;ToMD5, FieldNode&gt; { <i class="conum" data-value="2"></i><b>(2)</b>

    @Override
    void doVisit(AnnotationNode annotation, FieldNode node) { <i class="conum" data-value="3"></i><b>(3)</b>
        BlockStatement block  = buildMethodCode(node.name)
        MethodNode methodNode = A.NODES.method("${node.name}ToMD5")
            .modifiers(A.ACC.ACC_PUBLIC)
            .returnType(String)
            .code(block)
            .build()

        A.UTIL.CLASS.addMethod(node.declaringClass, methodNode)
    }

    private BlockStatement buildMethodCode(final String name) {
        A.STMT.blockSFromString """
            return java.security.MessageDigest
                .getInstance('MD5')
                .digest(${name}.getBytes())
                .encodeHex()
                .toString()
        """
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declaring when to apply this transformation with the annotation
<code>@Phase</code> and the correspondent compilation phase.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creating a class extending <code>AbstractLocalTransformation</code> and declaring
that the annotation and the affected node type are <code>ToMD5</code> and
<code>FieldNode</code> respectively</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The override method declares the correct generic type <code>FieldNode</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>From this line on you don&#8217;t have to be worried about casting first and
second node passed to your transformation anymore.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Sometimes it comes handy to get a reference to
<code>org.codehaus.groovy.control.SourceUnit</code>. In previous versions
<code>SourceUnit</code> was passed as argument, but it forced to add an import
whether you used or not. Now it&#8217;s present as a class field. Probably
in future release won&#8217;t be available directly but through specific
functions.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="__phase">5.5. @Phase</h3>
<div class="paragraph">
<p><code>@Phase</code> is a <strong>required</strong> annotation for both <code>global</code> and <code>local</code>
transformations that indicates in which compilation phase this
transformation will be applied.</p>
</div>
<div class="paragraph">
<p>Lets see how <code>@Phase</code> annotation is processed in a local transformation:</p>
</div>
<div class="imageblock" style="text-align: center">
<div class="content">
<img src="images//diag-865b3d1c4228cc4b6eda9b9f50c36d82.png" alt="Local Transformation" width="1130" height="154">
</div>
<div class="title">Figure 2. Local Transformation</div>
</div>
<div class="paragraph">
<p><code>@Phase</code> annotation needs a value of type
<code>org.codehaus.groovy.control.CompilePhase</code> enum, but because sometimes
is hard to remember which phases are available depending on which type
of transformation we are implementing and it would add one more import
to our code, <code>Asteroid</code> provides a shortcut to these values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>asteroid.Phase.LOCAL</code></p>
</li>
<li>
<p><code>asteroid.Phase.GLOBAL</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This way is always easier to remember how to get the proper
compilation phase. Here&#8217;s an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package asteroid.local.samples

import asteroid.A
import asteroid.Phase
import asteroid.AbstractLocalTransformation

import org.codehaus.groovy.ast.ClassNode
import org.codehaus.groovy.ast.AnnotationNode

@Phase(Phase.LOCAL.SEMANTIC_ANALYSIS) <i class="conum" data-value="1"></i><b>(1)</b>
class AsListImpl extends AbstractLocalTransformation&lt;AsList, ClassNode&gt; {

    @Override
    void doVisit(AnnotationNode annotation, ClassNode classNode) {
        classNode.superClass = A.NODES.clazz(ArrayList).build()
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This is a local transformation to be applied during <code>SEMANTIC_ANALYSIS</code> phase.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This transformation will be applied to those <code>ClassNode</code> instances
annotated with <code>@AsList</code>.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Groovy friendly</div>
<div class="paragraph">
<p>When used over a local transformation implementation in Groovy, apart
from indicating the compilation phase, underneath, it saves some of
the boilerplate code needed to implement an instance of
<code>asteroid.local.AbstractLocalTransformation</code>.</p>
</div>
<div class="paragraph">
<p>Although you can create an <code>AbstractLocalTransformation</code> in
plain Java, you then will have to annotate your transformations like
the old days.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_compilation_errors">5.6. Compilation errors</h3>
<div class="paragraph">
<p>If at some point you would like to stop the compilation process the
best approach is to use <code>addError</code> method. This method is available
in both <code>AbstractLocalTransformation</code> and <code>AbstractGlobalTransformation</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package asteroid.local.samples

import asteroid.Phase
import asteroid.AbstractLocalTransformation

import groovy.transform.CompileStatic
import org.codehaus.groovy.ast.ClassNode
import org.codehaus.groovy.ast.AnnotationNode

@CompileStatic
@Phase(Phase.LOCAL.SEMANTIC_ANALYSIS)
class GrumpyImpl extends AbstractLocalTransformation&lt;Grumpy, ClassNode&gt; {

    @Override
    void doVisit(AnnotationNode annotation, ClassNode clazz) {
        addError("I don't like you Argggg!!!!! (said the Grumpy transformation)", clazz)
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_checks">5.7. Checks</h3>
<div class="paragraph">
<p>There are many times when you have to check if all precoditions are
correct before applying a given transformation. Without this sanity
check, many things could go wrong. Checks labels are an effort to
avoid boiler plate code when checking the AST state. They are inspired
in Spock blocks.</p>
</div>
<div class="paragraph">
<p>By default checks labels are available in Asteroid local
transformations. All you have to do is to structure your code using
labels <code>check</code> and <code>then</code>.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example, it&#8217;s a bit silly but I think it will easy to
understand. We have a annotation called <code>@Serializable</code>.</p>
</div>
<div class="paragraph">
<p>The transformation <code>SerializableImpl</code> will make all classes annotated
with <code>@Serializable</code> to implement <code>java.io.Serializable</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package asteroid.local.samples

import asteroid.Local

@Local(SerializableImpl)
@interface Serializable {}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As constraints I want to make sure:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The annotated class package name should should start by 'asteroid'</p>
</li>
<li>
<p>The annotated class can only have two method at most</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package asteroid.local.samples

import groovy.transform.CompileStatic
import org.codehaus.groovy.ast.ClassNode
import org.codehaus.groovy.ast.AnnotationNode

import asteroid.A
import asteroid.Phase
import asteroid.AbstractLocalTransformation

@CompileStatic
@Phase(Phase.LOCAL.INSTRUCTION_SELECTION)
class SerializableImpl extends AbstractLocalTransformation&lt;Serializable, ClassNode&gt; {

    @Override
    void doVisit(AnnotationNode annotation, ClassNode classNode) {
        check: 'package starts with asteroid'
        classNode.packageName.startsWith('asteroid') <i class="conum" data-value="1"></i><b>(1)</b>

        check: 'there are least than 2 methods'
        classNode.methods.size() &lt; 2 <i class="conum" data-value="2"></i><b>(2)</b>

        then: 'make it implements Serializable and Cloneable'
        A.UTIL.CLASS.addInterfaces(classNode, java.io.Serializable, Cloneable) <i class="conum" data-value="3"></i><b>(3)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Checking the annotated class belongs to a certain <code>package</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Checking that the annotated node has less than two methods</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Transformation code</td>
</tr>
</table>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Limitations</div>
<div class="paragraph">
<p>Please notice at the moment checks only have a very limited
functionality. They only allow a <strong>one-line</strong> expression. And these
expressions can only see <code>doVisit</code> parameter values.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>To prove it, there&#8217;s a test with an annotated class having two
methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">    void testSerializableCheckersWork() {
        shouldFail '''
        package asteroid.local.samples

        @Serializable
        class A {
            def a() {}
            def b() {}
        }

        A something = new A()

        assert something instanceof java.io.Serializable
        assert something instanceof Cloneable

        '''
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the test&#8230;&#8203; passes :)</p>
</div>
<div class="sect3">
<h4 id="_your_own_transformations">5.7.1. Your own transformations</h4>
<div class="paragraph">
<p>If you would like to add this functionality in your project, you can
use Asteroid utility functions to inject this behavior in your code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-java" data-lang="java">Unresolved directive in local.adoc - include::../..//../../../asteroid-core/src/main/java/asteroid/internal/LocalTransformationTransformation.java[tags=addCheckTo,indent=0]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This call is taken from Asteroid local transformations. Checking is added to method <code>doVisit</code>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_global_transformations">6. Global Transformations</h2>
<div class="sectionbody">
<div class="quoteblock">
<blockquote>
Global AST transformation are similar to local one with a major
difference: they do not need an annotation, meaning that they are
applied globally, that is to say on each class being compiled. It is
therefore very important to limit their use to last resort, because it
can have a significant impact on the compiler performance.
</blockquote>
<div class="attribution">
&#8212; Groovy official site
</div>
</div>
<div class="sect2">
<h3 id="_overview_3">6.1. Overview</h3>
<div class="paragraph">
<p><code>Asteroid</code> suggest a certain way of creating global AST
transformations. Instead of creating a global transformation and
manipulate the <code>SourceUnit</code> directly, an <code>Asteroid</code> global
transformation only holds references to code transformers.</p>
</div>
<div class="paragraph">
<p>In order to create a local transformation you need to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create an <code>implementation</code> of the transformation extending
<code>AbstractGlobalTransformation</code></p>
</li>
<li>
<p>Create as many <code>transfomers</code> as you need and then make the
<code>getTransformers</code> method from your transformation to return the
classes of those transformers.</p>
</li>
<li>
<p>Your implementation should be annotated by <code>@Phase</code> with the proper
local compilation phase value set.</p>
</li>
<li>
<p>Add a <code>transformation descriptor</code> in your classpath to tell the
compiler where it can find your transformation</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_example_2">6.2. Example</h3>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package asteroid.global.samples

import static asteroid.Phase.GLOBAL

import groovy.transform.CompileStatic

import asteroid.Phase
import asteroid.AbstractGlobalTransformation
import asteroid.transformer.Transformer

@CompileStatic
@Phase(GLOBAL.CONVERSION) <i class="conum" data-value="1"></i><b>(1)</b>
class AddTransformation extends AbstractGlobalTransformation { <i class="conum" data-value="2"></i><b>(2)</b>

    @Override
    List&lt;Class&lt;Transformer&gt;&gt; getTransformers() {
        return [AddPropertyToInnerClass, AddTraitTransformer] <i class="conum" data-value="3"></i><b>(3)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declaring class as a global AST transformation</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Extending <code>asteroid.global.GlobalTransformationImpl</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Adding <code>asteroid.global.AbstractClassNodeTransformer</code> classes</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A global transformation needs to be annotated with the
<code>@GlobalTransformation</code> annotation, then it should extend
<code>GlobalTransformationImpl</code> and finally to provide a list of the
transformers that will eventually transform the code.</p>
</div>
<div class="paragraph">
<p>In this example the code of the transformer is the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">package asteroid.global.samples

import groovy.transform.CompileStatic

import org.codehaus.groovy.control.SourceUnit
import org.codehaus.groovy.ast.expr.Expression
import org.codehaus.groovy.ast.ClassNode

import asteroid.A
import asteroid.transformer.AbstractClassNodeTransformer

@CompileStatic
class AddPropertyToInnerClass extends AbstractClassNodeTransformer { <i class="conum" data-value="1"></i><b>(1)</b>

    AddPropertyToInnerClass(final SourceUnit sourceUnit) {
        super(sourceUnit, byNameContains('AddTransformerSpecExample$Input')) <i class="conum" data-value="2"></i><b>(2)</b>
    }

    @Override
    void transformClass(final ClassNode target) { <i class="conum" data-value="3"></i><b>(3)</b>
        A.UTIL.CLASS.addInterfaces(target, java.io.Serializable)
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Because this transformer targets class nodes it extends <code>ClassNodeTransformer</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Every <code>ClassNodeTransformer</code> requires a <code>SourceUnit</code> and a
criteria to filter class nodes</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Then the programmer should only be focused on develop de
transformation within the <code>transformClass</code> method</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Finally add the descriptor file to your classpath at
<code>META-INF/services/</code> the descriptor file should be named
<code>org.codehaus.groovy.transform.ASTTransformation</code>, and it will
contain the fully qualified name of your AST transformation implementation:
<code>asteroid.global.samples.AddTransformationImpl</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you are using <code>Gradle</code> or <code>Maven</code> the transformation
descriptor will be normally found at
<code>src/main/resources/META-INF/org.codehaus.groovy.transform.ASTTransformation</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Remember that for any new global transformation you should add
the new qualified class in a new line.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_transformers">6.3. Transformers</h3>
<div class="paragraph">
<p>Because a global AST transformation can act over the whole source
code, we use transformers to focus only on certain parts of
it. Transformers theirselves declare which type of nodes they are
interested in, but, they also use <code>criterias</code> to narrow the search.</p>
</div>
<div class="sect3">
<h4 id="_classnodetransformer">6.3.1. ClassNodeTransformer</h4>
<div class="paragraph">
<p>This type of transformers only focuses on transforming a specific set
of <code>ClassNode</code> instances from the AST.</p>
</div>
<div class="listingblock">
<div class="title">ClassNodeTransformer</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class AddImportTransformer extends AbstractClassNodeTransformer { <i class="conum" data-value="1"></i><b>(1)</b>

    public AddImportTransformer(final SourceUnit sourceUnit) {
        super(sourceUnit, byAnnotationName(AddImport.simpleName)) <i class="conum" data-value="2"></i><b>(2)</b>
    }

    /**
     * {@inheritDocs}
     */
    @Override
    void transformClass(final ClassNode target) { <i class="conum" data-value="3"></i><b>(3)</b>
        A.UTIL.CLASS.addImport(target, groovy.json.JsonOutput) <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Extending <code>ClassNodeTransformer</code> we are only interested in
<code>ClassNode</code> instances</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then we use a <code>criteria</code> to declare we&#8217;re only interested in
<code>ClassNode</code> instances annotated by an annotation which has a simple
name <code>AddImport</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Overriding the <code>transformClass</code> method we will be receiving the
expected <code>ClassNode</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We don&#8217;t return anything because we are modifying the node, we are
not supposed to replace it in the AST.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Why <code>simple name</code> ? Well depending on the compilation phase you
are targeting the information about the class may be not available,
that means it&#8217;s fully qualified name.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Transforming an AST node here means to add/remove elements
from the AST node.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_expression_transformers">6.3.2. Expression transformers</h4>
<div class="paragraph">
<p>This type of transformers only focuses on <strong>replacing</strong> certain
expressions found along the AST.</p>
</div>
<div class="paragraph">
<p>In the following example, we are interested in replacing all method
calls <code>xxx()</code> by a constant number <code>1</code>.</p>
</div>
<div class="listingblock">
<div class="title">ExpressionTransformer</div>
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">class ChangeTripleXToPlusOne
    extends AbstractExpressionTransformer&lt;MethodCallExpression&gt; { <i class="conum" data-value="1"></i><b>(1)</b>

    ChangeTripleXToPlusOne(final SourceUnit sourceUnit) {
        super(sourceUnit, methodCallByNameEq('xxx')) <i class="conum" data-value="2"></i><b>(2)</b>
    }

    @Override
    Expression transformExpression(final MethodCallExpression target) { <i class="conum" data-value="3"></i><b>(3)</b>
        return A.EXPR.constX(1)  <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We declare this transformer is focused on <code>MethodCallExpression</code>
elements</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We declare we are only interested on method calls with name <code>xxx</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Overriding the transformExpression operation we will be receiving
the expected node</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Finally will be returning the expression that will replace the
former expression in the AST</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
It&#8217;s very important to notice the fact that we are here
replacing an expression cause expressions are considered as values.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_fluent_api">7. Fluent API</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
With the upcoming <code>groovy-macro</code> module in Groovy 2.5.0 most
of the code in Asteroid, used for creating <code>expressions</code> and
<code>statements</code> may be gone for good in favor of the <code>macro</code> method.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The main goal of this project is to have a unified way to access all AST APIs through a single entry point. That
entry point is <code>asteroid.A</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>NODES</strong>: Create instances of <code>org.codehaus.groovy.ast.ASTNode</code></p>
</li>
<li>
<p><strong>EXPRESSIONS</strong>: Create instances of <code>org.codehaus.groovy.ast.expr.Expression</code></p>
</li>
<li>
<p><strong>STATEMENTS</strong>: Create instances of <code>org.codehaus.groovy.ast.stmt.Statement</code></p>
</li>
<li>
<p><strong>MODIFIERS</strong>: <code>asteroid.A.ACC</code></p>
</li>
<li>
<p><strong>CHECKERS</strong>: <code>asteroid.A.CHECK</code>. Access to checkers.</p>
</li>
<li>
<p><strong>UTILS</strong>: <code>asteroid.A.UTIL</code>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The project has been developed having in mind to get the general
idea reading this documentation and then checking the specifics using
the javadoc.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please check out the javadoc <a href="javadocs/index.html">here</a></p>
</div>
<div class="sect2">
<h3 id="_nodes">7.1. Nodes</h3>
<div class="paragraph">
<p>Check javadoc: <a href="javadocs/asteroid/Nodes.html"><code>asteroid.A.NODES</code></a></p>
</div>
<div class="paragraph">
<p>This is entry point accesses to a set of builders to create instances of <code>org.codehaus.groovy.ast.ASTNode</code>. All builders
in <code>asteroid.A.NODES</code> follow the same API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">A.NODES.annotation("MyAnnotation") <i class="conum" data-value="1"></i><b>(1)</b>
       .member(...) <i class="conum" data-value="2"></i><b>(2)</b>
       .xxxxxx(...)
       .yyyyyy(...)
       .build()  <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates a builder of a specific type of <code>ASTNode</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Then each node builder has a set of associated methods. E.g: <code>annotation</code> has <code>member(&#8230;&#8203;)</code> to add annotation members&#8230;&#8203;</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Once the node has been configured is time to create the instance calling the <code>build()</code> method of the
current builder.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For instance, the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">A.NODES.annotation("MyAnnotation")
       .member("message", A.EXPR.constX("hello"))
       .member("sort", A.EXPR.constX("desc"))
       .build()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Will produce the following annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">@MyAnnotation(message = "hello", sort = "desc")</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The nodes related javadoc has the same structure. Normally
you&#8217;ll see the AST and the resulting code explained.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_expressions_2">7.2. Expressions</h3>
<div class="paragraph">
<p>Check javadoc: <a href="javadocs/asteroid/Expressions.html"><code>asteroid.A.EXPR</code></a></p>
</div>
<div class="paragraph">
<p>This entry point accesses to a set of methods returning instances of <code>org.codehaus.groovy.ast.expr.Expression</code>.</p>
</div>
<div class="paragraph">
<p>Unlike the <code>asteroid.A.NODES</code> this entry point only has methods creating expressions directly. So bear in mind that
all methods from <code>asteroid.A.EXPR</code> will return instances of <code>org.codehaus.groovy.ast.Expression</code>.</p>
</div>
<div class="paragraph">
<p>For instance if we would like to create an expression like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">println "hello"</code></pre>
</div>
</div>
<div class="paragraph">
<p>We should code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">A.EXPR.callThisX( <i class="conum" data-value="1"></i><b>(1)</b>
    "println",
    A.EXPR.constX("hello") <i class="conum" data-value="2"></i><b>(2)</b>
)</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Creates an instance of <code>org.codehaus.groovy.ast.expr.MethodCallExpression</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creates an instance of <code>org.codehaus.groovy.ast.expr.ConstantExpression</code> used as method call argument.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Why using <code>callThisX</code> when coding <code>println</code> ? This is because <code>println</code> is added to all JDK objects
through the <code>DefaultGroovyMethods</code> object.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_statements_2">7.3. Statements</h3>
<div class="paragraph">
<p>Check javadoc: <a href="javadocs/asteroid/Statements.html"><code>asteroid.A.STMT</code></a></p>
</div>
<div class="quoteblock">
<blockquote>
In computer programming a statement is the smallest standalone element of an imperative programming language that
expresses some action to be carried out. It is an instruction written in a high-level language that commands the
computer to perform a specified action.[1] A program written in such a language is formed by a sequence of one or
more statements. A statement may have internal components (e.g., expressions).
</blockquote>
<div class="attribution">
&#8212; Wikipedia
</div>
</div>
<div class="paragraph">
<p>This entry point accesses to a set of methods returning instances of <code>org.codehaus.groovy.ast.stmt.Statement</code>. It
follows the same design as expressions. Each method returns an statement. For instance, a return statement:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">return 1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Can be written as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">A.STMT.returnS(A.EXPR.constX(1))</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_modifiers">7.4. Modifiers</h3>
<div class="paragraph">
<p>Check javadoc: <a href="javadocs/asteroid/Modifiers.html"><code>asteroid.A.ACC</code></a></p>
</div>
<div class="paragraph">
<p>When creating a node we may want to restrict its visibility, or mark it as <code>static</code>&#8230;&#8203;etc. To do that each node
has a method called <code>setModifiers(int)</code>. That value can be built with one or more values from this entry point:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-groovy" data-lang="groovy">A.ACC.ACC_PUBLIC // public</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_utils">7.5. Utils</h3>
<div class="paragraph">
<p>Check javadoc: <a href="javadocs/asteroid/Utils.html"><code>asteroid.A.UTIL</code></a></p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 0.2.1<br>
Last updated 2016-05-01 17:10:02 +00:00
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js"></script>
<script>prettyPrint()</script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.6.0/MathJax.js?config=TeX-MML-AM_HTMLorMML"></script>
</body>
</html>